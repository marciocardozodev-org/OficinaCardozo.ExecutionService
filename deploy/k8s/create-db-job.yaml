  
apiVersion: batch/v1
kind: Job
metadata:
  name: create-db-job
  namespace: default
spec:
  template:
    spec:
      containers:
      - name: psql
        image: postgres:15
        command: ["sh", "-c"]
        args:
        - export PGPASSWORD="$DB_PASSWORD" && psql -h "$DB_HOST" -U "$DB_USER" -d "$DB_NAME" -f /sql/create-db.sql
        env:
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              name: executionservice-db-secret
              key: DB_HOST
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: executionservice-db-secret
              key: DB_USER
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: executionservice-db-secret
              key: DB_PASSWORD
        - name: DB_NAME
          valueFrom:
            secretKeyRef:
              name: executionservice-db-secret
              key: DB_NAME
        volumeMounts:
        - name: sql-script
          mountPath: /sql
      restartPolicy: Never
      volumes:
      - name: sql-script
        configMap:
          name: create-db-sql
  backoffLimit: 1
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: create-db-sql
  namespace: default
  labels:
    app: executionservice
    tier: db
    managed-by: pipeline
    environment: prod
    microservice: executionservice
    purpose: migration
    type: sql-script
    version: v1
data:
  create-db.sql: |
    -- Script de criação das tabelas principais do ExecutionService
    -- Tabela: atualizacao_status_os
    CREATE TABLE IF NOT EXISTS atualizacao_status_os (
      id INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
      ordem_servico_id INTEGER NOT NULL,
      novo_status VARCHAR(100) NOT NULL,
      atualizado_em TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
    );
    CREATE INDEX IF NOT EXISTS idx_atualizacao_status_os_ordem_servico_id ON atualizacao_status_os(ordem_servico_id);

    -- Tabela: execucao_os
    CREATE TABLE IF NOT EXISTS execucao_os (
      id INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
      ordem_servico_id INTEGER NOT NULL,
      status_atual VARCHAR(100) NOT NULL,
      inicio_execucao TIMESTAMP NULL,
      fim_execucao TIMESTAMP NULL,
      diagnostico TEXT NULL,
      reparo TEXT NULL,
      finalizado BOOLEAN NOT NULL DEFAULT FALSE
    );
    CREATE INDEX IF NOT EXISTS idx_execucao_os_ordem_servico_id ON execucao_os(ordem_servico_id);

    -- Tabela: ExecutionJobs (nova arquitetura de processamento)
    CREATE TABLE IF NOT EXISTS "ExecutionJobs" (
      "Id" UUID PRIMARY KEY,
      "OsId" VARCHAR(50) NOT NULL,
      "Status" INTEGER NOT NULL,
      "Attempt" INTEGER NOT NULL DEFAULT 1,
      "LastError" VARCHAR(500),
      "CreatedAt" TIMESTAMP NOT NULL,
      "UpdatedAt" TIMESTAMP,
      "FinishedAt" TIMESTAMP,
      "CorrelationId" VARCHAR(100)
    );
    CREATE UNIQUE INDEX IF NOT EXISTS "IX_ExecutionJobs_OsId" ON "ExecutionJobs"("OsId");

    -- Tabela: InboxEvents (idempotency pattern)
    CREATE TABLE IF NOT EXISTS "InboxEvents" (
      "Id" UUID PRIMARY KEY,
      "EventId" VARCHAR(100) NOT NULL,
      "EventType" VARCHAR(100) NOT NULL,
      "ReceivedAt" TIMESTAMP NOT NULL
    );
    CREATE UNIQUE INDEX IF NOT EXISTS "IX_InboxEvents_EventId" ON "InboxEvents"("EventId");

    -- Tabela: OutboxEvents (reliable publishing pattern)
    CREATE TABLE IF NOT EXISTS "OutboxEvents" (
      "Id" UUID PRIMARY KEY,
      "EventType" VARCHAR(100) NOT NULL,
      "Payload" TEXT NOT NULL,
      "CorrelationId" VARCHAR(100),
      "CreatedAt" TIMESTAMP NOT NULL,
      "Published" BOOLEAN NOT NULL DEFAULT FALSE,
      "PublishedAt" TIMESTAMP
    );
    CREATE INDEX IF NOT EXISTS "IX_OutboxEvents_Published" ON "OutboxEvents"("Published");

